---
title: "Yi Lui Data Analysis: Transfer Efficiency"
author: "MFK"
date: "25/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r setup}
pacman::p_load(dplyr,brms,tidyr,ggplot2,lme4)

```


## Fluorescent powder
This imports Yi lui's data 

```{r Yi's data import}
dY<-vroom::vroom("data/Yi.data.longformat.20191121_censoring_handled.csv") %>% janitor::clean_names()

skimr::skim(dY)


# Individual powder area vs contact number and loading weight 
dY %>% 
  filter(surface=="Plastic" ) %>% 
  filter(id<21) %>% 
  ggplot()+
  geom_point(aes(x=contact_number,y=raw_int_d/(powder_area*loading_weight),colour=gloves))+
  geom_smooth(aes(x=contact_number,y=raw_int_d/(powder_area*loading_weight),colour=gloves),method="lm",se=FALSE)+
  scale_y_continuous(trans="log10")+
  facet_wrap(~id,scales="free")+
  scale_colour_brewer(palette = "Set1")+
  hrbrthemes::theme_ipsum()

# Raw int violin plots faceted by surface
dY %>% 
  # filter(surface=="Plastic" ) %>% 
  # group_by(surface,contact_number,gloves) %>% 
  # summarise(Mean=mean(powder_area),SD=sd(powder_area))
  ggplot()+
  geom_violin(aes(x=as.factor(contact_number),y=raw_int_d,fill=gloves),draw_quantiles = c(0.25,0.5,0.95))+
  scale_y_continuous(trans = "log10")+
  scale_fill_brewer(palette = "Set1")+
  facet_wrap(~surface,scales="free",nrow=3)+
  ylab("Raw intensity")+
  xlab("Contact number")+
  labs(fill = "Gloves")+
  hrbrthemes::theme_ipsum()

```

# Some investigative plots
```{r investigative plots}
#Plot log10(raw_int_d) vs contact_number for each ID and colour by gloves
dY%>%
filter(surface=="Plastic") %>%
filter(id>20 & id<=40) %>%
ggplot()+
geom_point(aes(x=contact_number,y=raw_int_d,colour=gloves),size=4)+
scale_colour_brewer(palette="Set1")+
scale_y_continuous(trans="log10")+
facet_wrap(~id)+
xlab("Contact number")+
ylab("Intensity units")+
theme_bw()+
labs(color='Gloves')+
theme(text = element_text(size=14),axis.text.x=element_text(size=14))  ->a

#save ggplot figure
# ggsave(a,"images/intensity_for_each_ID.png",device="png",units=c("cm"),width=30)
ggsave(a,filename = "images/intensity_for_each_ID_plastic_21_40.png",dpi=300, device="png",width = 10, height = 10, units = "in")


# Create a scatter plot of the intensity for each ID and colour by gloves, facet by surface

dY%>%
ggplot()+
geom_jitter(aes(x=contact_number,y=raw_int_d/powder_area,colour=date),size=4,alpha=0.4)+
scale_colour_brewer(palette="Set1")+
# geom_smooth(method="lm",se=TRUE,aes(x=contact_number,y=raw_int_d/powder_area,colour=gloves))+
facet_grid(gloves~surface)+
xlab("Contact number")+
ylab("Intensity units")+
scale_y_continuous(trans = "log10")+
theme_bw()+
labs(color='Date')+
theme(text = element_text(size=14),axis.text.x=element_text(size=14))  ->a

ggsave(a,filename = "images/aggregated_intensity.png",dpi=300, device="png",width = 12, height = 10, units = "in")




```

# LMER4 model fit
Here we fit a Linear Mixed Effects Model using LMER4 to the data.

```{r LMER4 raw_int_d }
#Here we fit a LMER4 model from LMER4 to the data, with raw_ind_d as the dependent variable
#We
model_fit_g<-lme4::lmer(raw_int_d~powder_area+contact_number+gloves+surface+(powder_area+contact_number+gloves+surface|id),
                  data = dY)
summary(model_fit_g)
plot(model_fit_g)

```


# BRMS model fit
Here we fit a Bayesian Regression Model using BRMS to the data.

```{r BRM raw_int_d }
#Here we fit a BRM model from BRSM to the data, with raw_ind_d as the dependent variable
#We 
model_fit_BRMS<-brms::brm(data = dY,raw_int_d~powder_area+contact_number+gloves+surface+(powder_area+contact_number+gloves+surface|id),
                       family = lognormal(link = "identity", link_sigma = "log"))
summary(model_fit_BRMS)
plot(model_fit_BRMS)

```












